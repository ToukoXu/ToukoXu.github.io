<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>代理（Proxy）：ES6 元编程的“对象拦截器” | Touko</title><meta name="keywords" content="JavaScript,性能优化,ES6"><meta name="author" content="Touko"><meta name="copyright" content="Touko"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="代理（Proxy）：ES6 元编程的“对象拦截器”"><meta name="application-name" content="代理（Proxy）：ES6 元编程的“对象拦截器”"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="代理（Proxy）：ES6 元编程的“对象拦截器”"><meta property="og:url" content="http://toukoxu.github.io/2024/08/15/proxy/index.html"><meta property="og:site_name" content="Touko"><meta property="og:description" content="Proxy 是 ES6 引入的元编程特性，简单说就是给对象“装一层拦截器”——所有对对象的操作（比如读属性、改属性、删属性），都会先经过这层拦截器，我们可以在拦截器里自定义操作逻辑。它的灵活性极高，是 Vue3 响应式、数据验证、API 拦截等场景的核心技术。  关联知识可以将 Proxy 和 R"><meta property="og:locale" content="zh"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/proxy.png"><meta property="article:author" content="Touko"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/proxy.png"><meta name="description" content="Proxy 是 ES6 引入的元编程特性，简单说就是给对象“装一层拦截器”——所有对对象的操作（比如读属性、改属性、删属性），都会先经过这层拦截器，我们可以在拦截器里自定义操作逻辑。它的灵活性极高，是 Vue3 响应式、数据验证、API 拦截等场景的核心技术。  关联知识可以将 Proxy 和 R"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://toukoxu.github.io/2024/08/15/proxy/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2024/07/27/125766904/ba62475f396df9de3316a08ed9e65d86_5680958632268053399..png"},
  postHeadAiDescription: undefined,
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"both","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["🤖️ 科技爱好者","🔨 开发一条龙","🌌 Hello World 宇宙","⌨️ 键盘撸猫区","🐱 万物皆可rua"]},
  algolia: {"appId":"SVGIUL6D7W","apiKey":"aee53519dcfc6f122cfe52009938fc1c","indexName":"blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"本文最后一次更新为","messageNext":"天前，文章中的某些内容可能已过时！"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Touko","link":"链接: ","source":"来源: Touko","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Touko',
  title: '代理（Proxy）：ES6 元编程的“对象拦截器”',
  postAI: '',
  pageFillDescription: '关联知识, 一、Proxy 的核心：三要素与基础用法, 二、13 种核心拦截方法：覆盖所有对象操作, 三、Proxy 的实战场景：这些地方用它最香, 3.1 响应式数据（Vue3 核心原理）, 3.2 数据验证：确保属性值符合规则, 3.3 API 请求拦截：统一管理接口调用, 3.4 自动持久化：修改数据自动存到本地存储, 3.5 数组变化监听：完美支持数组方法, 四、Proxy 实战注意事项与优化, 4.1 必须用 Reflect 保持默认行为, 4.2 避免过度代理：减少性能开销, 4.3 嵌套对象代理：需要递归处理, 4.4 浏览器兼容性：旧环境回退, 五、Proxy vs Object.defineProperty：核心差异, 六、Proxy 的局限性是引入的元编程特性简单说就是给对象装一层拦截器所有对对象的操作比如读属性改属性删属性都会先经过这层拦截器我们可以在拦截器里自定义操作逻辑它的灵活性极高是响应式数据验证拦截等场景的核心技术关联知识可以将和合并在一起学习站内地址标准化对象操作的工具库一的核心三要素与基础用法的使用很直观核心是这个构造函数需要传入两个关键参数基本语法创建一个代理对象被代理的目标对象可以是普通对象数组函数甚至另一个代理拦截器配置对象里面定义了各种拦截方法比如拦截读操作拦截写操作生成的代理对象后续操作都要通过这个代理对象才能触发拦截逻辑举个最简单的例子给普通对象加一层拦截监控属性的读写目标对象一个普通用户对象拦截器配置定义要拦截的操作拦截读属性操作比如正在读取属性用保持默认读逻辑避免破坏原对象行为拦截写属性操作比如正在修改属性从改成用保持默认写逻辑创建代理对象测试拦截效果触发输出正在读取属性再输出触发输出正在修改属性从改成二种核心拦截方法覆盖所有对象操作提供了种拦截方法覆盖了对象的几乎所有基础操作我整理了日常开发中最常用的几种按使用频率排序拦截器方法触发时机示例核心作用读取对象属性时监控属性读取返回自定义值比如默认值设置对象属性时验证属性值监控属性修改使用操作符时自定义属性是否存在的判断逻辑使用操作时监控属性删除阻止敏感属性删除代理的目标是函数且函数被调用时拦截函数调用修改参数或返回值代理的目标是构造函数且用创建实例时拦截实例创建修改实例属性遍历对象属性时如自定义遍历返回的属性列表比如隐藏敏感属性其他拦截方法多用于底层元编程日常开发中较少直接使用了解即可三的实战场景这些地方用它最香响应式数据核心原理的响应式系统就是基于实现的通过拦截对象的收集依赖和触发更新实现数据变视图自动变简化版实现如下存储依赖是目标对象是该对象各属性的依赖列表收集依赖记录哪个函数在用这个属性这里简化处理实际中会关联组件渲染函数假设当前依赖是一个更新函数属性变了更新视图触发更新通知所有依赖该属性的函数执行生成响应式对象的核心函数避免重复代理同一对象只代理一次读取属性时收集依赖嵌套对象递归代理比如也能响应只有值真的变了才触发更新测试响应式触发输出属性变了更新视图嵌套对象也触发输出属性变了更新视图数据验证确保属性值符合规则比如要求必须是正整数不能是空字符串通过拦截器就能实现定义验证规则的拦截器验证必须是正整数年龄无效必须是正整数验证不能是空字符串姓名不能为空验证通过执行默认的赋值逻辑创建带验证的代理对象测试验证逻辑验证通过验证通过报错年龄无效必须是正整数报错姓名不能为空请求拦截统一管理接口调用比如给所有调用加请求日志和基础拼接不用每次调用都写重复逻辑目标对象存储基础配置拦截器拦截属性访问返回封装后的请求函数比如访问返回一个请求接口的函数统一加请求日志调用参数统一拼接基础发送请求创建代理调用简洁且统一调用调用自动持久化修改数据自动存到本地存储比如让配置数据修改后自动保存到刷新页面也不会丢创建自动持久化的代理函数从读取已有数据没有则用初始值拦截操作修改后自动保存自动同步到创建自动持久化的配置对象测试修改后自动保存到里的会自动更新同样自动保存数组变化监听完美支持数组方法能原生拦截数组的等方法不用像那样做特殊数组拦截器监控数组操作拦截数组的变异方法等返回包装后的方法保留原逻辑并加监控数组执行参数调用数组原生方法非数组方法走默认逻辑测试数组代理触发拦截输出数组执行参数数组变成触发拦截输出数组执行参数数组变成四实战注意事项与优化必须用保持默认行为是配合推出的它的方法和的拦截器一一对应比如对应拦截器在拦截器里用而不是直接操作能确保保持对象的默认行为比如指向正确正确处理复杂场景比如继承属性不可写属性反例不推荐直接操作可能破坏继承等默认行为正例推荐用保持默认行为避免过度代理减少性能开销虽然灵活但创建和递归代理会有性能开销尤其是处理大型对象或频繁操作时优化技巧避免重复代理用缓存已代理的对象同一对象只代理一次参考响应式的浅层代理优先如果只需要监控顶层属性不用递归代理嵌套对象性能关键场景不用比如高频更新的列表大型数据计算用普通对象更高效嵌套对象代理需要递归处理只能拦截直接操作的属性如果目标对象有嵌套对象比如直接代理顶层对象无法拦截嵌套属性的操作需要在拦截器里递归代理嵌套对象如果值是对象且非递归代理修改测试嵌套代理触发输出修改浏览器兼容性旧环境回退不支持浏览器如果需要兼容旧环境可以用做回退类似的响应式方案现代浏览器用旧浏览器用模拟仅支持数组回退拦截索引和长度对象回退拦截属性五核心差异很多人会把和的对比两者都是对象拦截方案但更强大更灵活特性嵌套对象监听支持需递归代理不支持需手动递归实现数组监听原生支持等方法需数组原型不完美新增属性监听自动支持比如不支持需手动调用删除属性监听支持不支持拦截操作数量种覆盖所有对象操作仅种性能现代浏览器优化良好一般场景足够用稍快但功能有限浏览器支持现代浏览器不支持支持到简单说如果不需要兼容优先用如果需要兼容旧环境才考虑六的局限性虽强但也有一些无法突破的限制无法拦截全等比较永远是代理和原对象是两个不同的引用无法拦截某些内部方法比如返回的是代理对象的类型无法自定义序列化问题代理对象不能直接用序列化会序列化原对象的属性但拦截逻辑不生效内存消耗深度代理大型对象比如嵌套多层的数组对象会占用较多内存是中最强大的特性之一它的核心价值在于不修改原对象却能自定义对象的行为这种非侵入式的拦截能力让它在框架开发工具库数据处理等场景中大放异彩掌握不仅能看懂等框架的底层逻辑还能写出更灵活更优雅的代码',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-15 20:46:25',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link href="https://fonts.cdnfonts.com/css/shina-baby" rel="stylesheet"><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/site/loading.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">Touko</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/pay/wechat.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/pay/wechat.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/pay/alipay.jpg" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/pay/alipay.jpg"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/ES2017-ES8/" style="font-size: 1.05rem;">ES2017(ES8)<sup>1</sup></a><a href="/tags/ES6/" style="font-size: 1.05rem;">ES6<sup>6</sup></a><a href="/tags/JavaScript/" style="font-size: 1.05rem;">JavaScript<sup>10</sup></a><a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 1.05rem;">性能优化<sup>6</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">August 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">July 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">June 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/02/"><span class="card-archive-list-date">February 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/05/"><span class="card-archive-list-date">May 2021</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/04/"><span class="card-archive-list-date">April 2021</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/03/"><span class="card-archive-list-date">March 2021</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url">前端</a><i class="anzhiyufont anzhiyu-icon-angle-right post-meta-separator"></i><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%89%8D%E7%AB%AF/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url">学习笔记</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/JavaScript/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>JavaScript</span></a><a class="article-meta__tags" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>性能优化</span></a><a class="article-meta__tags" href="/tags/ES6/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>ES6</span></a></span></div></div><h1 class="post-title" itemprop="name headline">代理（Proxy）：ES6 元编程的“对象拦截器”</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-08-15T12:46:25.000Z" title="发表于 2024-08-15 20:46:25">2024-08-15</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-08-15T12:46:25.000Z" title="更新于 2024-08-15 20:46:25">2024-08-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">3.4k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>13分钟</span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为上海"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>上海</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/proxy.png"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://toukoxu.github.io/2024/08/15/proxy/"><header><a class="post-meta-categories" href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url">前端</a><a class="post-meta-categories" href="/categories/%E5%89%8D%E7%AB%AF/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url">学习笔记</a><a href="/tags/JavaScript/" tabindex="-1" itemprop="url">JavaScript</a><a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" tabindex="-1" itemprop="url">性能优化</a><a href="/tags/ES6/" tabindex="-1" itemprop="url">ES6</a><h1 id="CrawlerTitle" itemprop="name headline">代理（Proxy）：ES6 元编程的“对象拦截器”</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Touko</span><time itemprop="dateCreated datePublished" datetime="2024-08-15T12:46:25.000Z" title="发表于 2024-08-15 20:46:25">2024-08-15</time><time itemprop="dateCreated datePublished" datetime="2024-08-15T12:46:25.000Z" title="更新于 2024-08-15 20:46:25">2024-08-15</time></header><blockquote>
<p><strong>Proxy</strong> 是 ES6 引入的元编程特性，简单说就是给对象“装一层拦截器”——所有对对象的操作（比如读属性、改属性、删属性），都会先经过这层拦截器，我们可以在拦截器里自定义操作逻辑。它的灵活性极高，是 Vue3 响应式、数据验证、API 拦截等场景的核心技术。</p>
</blockquote>
<h2 id="关联知识"><a href="#关联知识" class="headerlink" title="关联知识"></a>关联知识</h2><p>可以将 Proxy 和 Reflect 合并在一起学习～</p>
<div calss='anzhiyu-tag-link'><a class="tag-Link" target="_blank" href="/2024/08/14/reflect">
    <div class="tag-link-tips">站内地址</div>
    <div class="tag-link-bottom">
        <div class="tag-link-left" style="background-image: url(/img/512.png)">
          <i class="anzhiyufont anzhiyu-icon-link" style="display: none"></i>
        </div>
        <div class="tag-link-right">
            <div class="tag-link-title">Reflect：ES6 标准化对象操作的“工具库”</div>
            <div class="tag-link-sitename"> Touko</div>
        </div>
        <i class="anzhiyufont anzhiyu-icon-angle-right"></i>
    </div>
    </a></div>

<h2 id="一、Proxy-的核心：三要素与基础用法"><a href="#一、Proxy-的核心：三要素与基础用法" class="headerlink" title="一、Proxy 的核心：三要素与基础用法"></a>一、Proxy 的核心：三要素与基础用法</h2><p>Proxy 的使用很直观，核心是 <code>new Proxy(target, handler)</code> 这个构造函数，需要传入两个关键参数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本语法：创建一个代理对象</span></span><br><span class="line"><span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(target, handler);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>target</strong>：被代理的“目标对象”（可以是普通对象、数组、函数，甚至另一个代理）。</li>
<li><strong>handler</strong>：“拦截器配置对象”，里面定义了各种“拦截方法”（比如 <code>get</code> 拦截读操作，<code>set</code> 拦截写操作）。</li>
<li><strong>proxy</strong>：生成的“代理对象”——后续操作都要通过这个代理对象，才能触发拦截逻辑。</li>
</ul>
<p>举个最简单的例子：给普通对象加一层拦截，监控属性的读写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目标对象：一个普通用户对象</span></span><br><span class="line"><span class="keyword">const</span> user = &#123; <span class="attr">name</span>: <span class="string">&#x27;Alice&#x27;</span>, <span class="attr">age</span>: <span class="number">28</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拦截器配置：定义要拦截的操作</span></span><br><span class="line"><span class="keyword">const</span> userHandler = &#123;</span><br><span class="line">  <span class="comment">// 拦截“读属性”操作（比如 proxy.name）</span></span><br><span class="line">  <span class="title function_">get</span>(<span class="params">target, propKey</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`正在读取属性：<span class="subst">$&#123;propKey&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// 用 Reflect.get 保持默认读逻辑（避免破坏原对象行为）</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, propKey);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 拦截“写属性”操作（比如 proxy.age = 29）</span></span><br><span class="line">  <span class="title function_">set</span>(<span class="params">target, propKey, value</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`正在修改属性 <span class="subst">$&#123;propKey&#125;</span>：从 <span class="subst">$&#123;target[propKey]&#125;</span> 改成 <span class="subst">$&#123;value&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// 用 Reflect.set 保持默认写逻辑</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, propKey, value);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建代理对象</span></span><br><span class="line"><span class="keyword">const</span> proxyUser = <span class="keyword">new</span> <span class="title class_">Proxy</span>(user, userHandler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试拦截效果</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(proxyUser.<span class="property">name</span>); <span class="comment">// 触发 get：输出“正在读取属性：name”，再输出“Alice”</span></span><br><span class="line">proxyUser.<span class="property">age</span> = <span class="number">29</span>; <span class="comment">// 触发 set：输出“正在修改属性 age：从 28 改成 29”</span></span><br></pre></td></tr></table></figure>

<h2 id="二、13-种核心拦截方法：覆盖所有对象操作"><a href="#二、13-种核心拦截方法：覆盖所有对象操作" class="headerlink" title="二、13 种核心拦截方法：覆盖所有对象操作"></a>二、13 种核心拦截方法：覆盖所有对象操作</h2><p>Proxy 提供了 13 种拦截方法，覆盖了对象的几乎所有基础操作。我整理了日常开发中最常用的几种，按使用频率排序：</p>
<table>
<thead>
<tr>
<th>拦截器方法</th>
<th>触发时机</th>
<th>示例</th>
<th>核心作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>get(target, propKey, receiver)</code></td>
<td>读取对象属性时</td>
<td><code>proxy.name</code>、<code>proxy[0]</code></td>
<td>监控属性读取、返回自定义值（比如默认值）</td>
</tr>
<tr>
<td><code>set(target, propKey, value, receiver)</code></td>
<td>设置对象属性时</td>
<td><code>proxy.age = 30</code></td>
<td>验证属性值、监控属性修改</td>
</tr>
<tr>
<td><code>has(target, propKey)</code></td>
<td>使用 <code>in</code> 操作符时</td>
<td><code>&#39;name&#39; in proxy</code></td>
<td>自定义“属性是否存在”的判断逻辑</td>
</tr>
<tr>
<td><code>deleteProperty(target, propKey)</code></td>
<td>使用 <code>delete</code> 操作时</td>
<td><code>delete proxy.age</code></td>
<td>监控属性删除、阻止敏感属性删除</td>
</tr>
<tr>
<td><code>apply(target, thisArg, args)</code></td>
<td>代理的目标是函数，且函数被调用时</td>
<td><code>proxy(1, 2)</code></td>
<td>拦截函数调用、修改参数或返回值</td>
</tr>
<tr>
<td><code>construct(target, args)</code></td>
<td>代理的目标是构造函数，且用 <code>new</code> 创建实例时</td>
<td><code>new proxy(1, 2)</code></td>
<td>拦截实例创建、修改实例属性</td>
</tr>
<tr>
<td><code>ownKeys(target)</code></td>
<td>遍历对象属性时（如 <code>Object.keys(proxy)</code>、<code>for...in</code>）</td>
<td><code>Object.keys(proxy)</code></td>
<td>自定义遍历返回的属性列表（比如隐藏敏感属性）</td>
</tr>
</tbody></table>
<p>其他拦截方法多用于底层元编程，日常开发中较少直接使用，了解即可。</p>
<ul>
<li>getOwnPropertyDescriptor(target, propKey)</li>
<li>defineProperty(target, propKey, propDesc)</li>
<li>preventExtensions(target)</li>
<li>getPrototypeOf(target)</li>
<li>isExtensible(target)</li>
<li>setPrototypeOf(target, proto)</li>
</ul>
<h2 id="三、Proxy-的实战场景：这些地方用它最香"><a href="#三、Proxy-的实战场景：这些地方用它最香" class="headerlink" title="三、Proxy 的实战场景：这些地方用它最香"></a>三、Proxy 的实战场景：这些地方用它最香</h2><h3 id="3-1-响应式数据（Vue3-核心原理）"><a href="#3-1-响应式数据（Vue3-核心原理）" class="headerlink" title="3.1 响应式数据（Vue3 核心原理）"></a>3.1 响应式数据（Vue3 核心原理）</h3><p>Vue3 的响应式系统就是基于 Proxy 实现的——通过拦截对象的 <code>get</code>（收集依赖）和 <code>set</code>（触发更新），实现“数据变，视图自动变”。</p>
<p>简化版实现如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存储依赖：key 是目标对象，value 是该对象各属性的依赖列表</span></span><br><span class="line"><span class="keyword">const</span> reactiveMap = <span class="keyword">new</span> <span class="title class_">WeakMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收集依赖：记录“哪个函数在用这个属性”</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, propKey</span>) &#123;</span><br><span class="line">  <span class="comment">// 这里简化处理，实际 Vue 中会关联组件渲染函数</span></span><br><span class="line">  <span class="keyword">if</span> (!reactiveMap.<span class="title function_">has</span>(target)) &#123;</span><br><span class="line">    reactiveMap.<span class="title function_">set</span>(target, <span class="keyword">new</span> <span class="title class_">Map</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> propMap = reactiveMap.<span class="title function_">get</span>(target);</span><br><span class="line">  <span class="keyword">if</span> (!propMap.<span class="title function_">has</span>(propKey)) &#123;</span><br><span class="line">    propMap.<span class="title function_">set</span>(propKey, <span class="keyword">new</span> <span class="title class_">Set</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 假设当前依赖是一个“更新函数”</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">updateFn</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`属性 <span class="subst">$&#123;propKey&#125;</span> 变了，更新视图！`</span>);</span><br><span class="line">  propMap.<span class="title function_">get</span>(propKey).<span class="title function_">add</span>(updateFn);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 触发更新：通知所有依赖该属性的函数执行</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, propKey</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!reactiveMap.<span class="title function_">has</span>(target)) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">const</span> propMap = reactiveMap.<span class="title function_">get</span>(target);</span><br><span class="line">  <span class="keyword">if</span> (propMap.<span class="title function_">has</span>(propKey)) &#123;</span><br><span class="line">    propMap.<span class="title function_">get</span>(propKey).<span class="title function_">forEach</span>(<span class="function">(<span class="params">fn</span>) =&gt;</span> <span class="title function_">fn</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成响应式对象的核心函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reactive</span>(<span class="params">target</span>) &#123;</span><br><span class="line">  <span class="comment">// 避免重复代理（同一对象只代理一次）</span></span><br><span class="line">  <span class="keyword">if</span> (reactiveMap.<span class="title function_">has</span>(target)) <span class="keyword">return</span> reactiveMap.<span class="title function_">get</span>(target);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(target, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, propKey, receiver</span>) &#123;</span><br><span class="line">      <span class="comment">// 读取属性时，收集依赖</span></span><br><span class="line">      <span class="title function_">track</span>(target, propKey);</span><br><span class="line">      <span class="keyword">const</span> value = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, propKey, receiver);</span><br><span class="line">      <span class="comment">// 嵌套对象递归代理（比如 user.address.city 也能响应）</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">&#x27;object&#x27;</span> &amp;&amp; value !== <span class="literal">null</span></span><br><span class="line">        ? <span class="title function_">reactive</span>(value)</span><br><span class="line">        : value;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, propKey, value, receiver</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> oldValue = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, propKey, receiver);</span><br><span class="line">      <span class="keyword">const</span> success = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, propKey, value, receiver);</span><br><span class="line">      <span class="comment">// 只有值真的变了，才触发更新</span></span><br><span class="line">      <span class="keyword">if</span> (oldValue !== value) &#123;</span><br><span class="line">        <span class="title function_">trigger</span>(target, propKey);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> success;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  reactiveMap.<span class="title function_">set</span>(target, proxy);</span><br><span class="line">  <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试响应式</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="title function_">reactive</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;Bob&#x27;</span>, <span class="attr">address</span>: &#123; <span class="attr">city</span>: <span class="string">&#x27;Beijing&#x27;</span> &#125; &#125;);</span><br><span class="line">user.<span class="property">name</span> = <span class="string">&#x27;Charlie&#x27;</span>; <span class="comment">// 触发 set → 输出“属性 name 变了，更新视图！”</span></span><br><span class="line">user.<span class="property">address</span>.<span class="property">city</span> = <span class="string">&#x27;Shanghai&#x27;</span>; <span class="comment">// 嵌套对象也触发 → 输出“属性 city 变了，更新视图！”</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-数据验证：确保属性值符合规则"><a href="#3-2-数据验证：确保属性值符合规则" class="headerlink" title="3.2 数据验证：确保属性值符合规则"></a>3.2 数据验证：确保属性值符合规则</h3><p>比如要求 <code>age</code> 必须是正整数，<code>name</code> 不能是空字符串——通过 <code>set</code> 拦截器就能实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义验证规则的拦截器</span></span><br><span class="line"><span class="keyword">const</span> validatorHandler = &#123;</span><br><span class="line">  <span class="title function_">set</span>(<span class="params">target, propKey, value</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (propKey) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;age&#x27;</span>:</span><br><span class="line">        <span class="comment">// 验证 age 必须是正整数</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title class_">Number</span>.<span class="title function_">isInteger</span>(value) || value &lt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`年龄 <span class="subst">$&#123;value&#125;</span> 无效！必须是正整数`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;name&#x27;</span>:</span><br><span class="line">        <span class="comment">// 验证 name 不能是空字符串</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> value !== <span class="string">&#x27;string&#x27;</span> || value.<span class="title function_">trim</span>() === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;姓名不能为空！&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 验证通过，执行默认的赋值逻辑</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, propKey, value);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建带验证的代理对象</span></span><br><span class="line"><span class="keyword">const</span> person = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;&#125;, validatorHandler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试验证逻辑</span></span><br><span class="line">person.<span class="property">age</span> = <span class="number">30</span>; <span class="comment">// 验证通过</span></span><br><span class="line">person.<span class="property">name</span> = <span class="string">&#x27;David&#x27;</span>; <span class="comment">// 验证通过</span></span><br><span class="line"></span><br><span class="line">person.<span class="property">age</span> = <span class="string">&#x27;thirty&#x27;</span>; <span class="comment">// 报错：TypeError: 年龄 thirty 无效！必须是正整数</span></span><br><span class="line">person.<span class="property">name</span> = <span class="string">&#x27;&#x27;</span>; <span class="comment">// 报错：TypeError: 姓名不能为空！</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-API-请求拦截：统一管理接口调用"><a href="#3-3-API-请求拦截：统一管理接口调用" class="headerlink" title="3.3 API 请求拦截：统一管理接口调用"></a>3.3 API 请求拦截：统一管理接口调用</h3><p>比如给所有 API 调用加“请求日志”和“基础 URL 拼接”，不用每次调用都写重复逻辑：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目标对象：存储 API 基础配置</span></span><br><span class="line"><span class="keyword">const</span> apiConfig = &#123; <span class="attr">baseURL</span>: <span class="string">&#x27;https://api.example.com&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// API 拦截器：拦截属性访问，返回封装后的请求函数</span></span><br><span class="line"><span class="keyword">const</span> apiHandler = &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">target, endpoint</span>) &#123;</span><br><span class="line">    <span class="comment">// 比如访问 api.users，返回一个请求 /users 接口的函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">async</span> (params) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 统一加请求日志</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`调用 API：<span class="subst">$&#123;endpoint&#125;</span>，参数：`</span>, params);</span><br><span class="line">      <span class="comment">// 统一拼接基础 URL</span></span><br><span class="line">      <span class="keyword">const</span> url = <span class="string">`<span class="subst">$&#123;target.baseURL&#125;</span>/<span class="subst">$&#123;endpoint&#125;</span>`</span>;</span><br><span class="line">      <span class="comment">// 发送请求</span></span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        <span class="attr">headers</span>: &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span> &#125;,</span><br><span class="line">        <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(params),</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 API 代理</span></span><br><span class="line"><span class="keyword">const</span> api = <span class="keyword">new</span> <span class="title class_">Proxy</span>(apiConfig, apiHandler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 API：简洁且统一</span></span><br><span class="line"><span class="keyword">const</span> userData = <span class="keyword">await</span> api.<span class="title function_">users</span>(&#123; <span class="attr">id</span>: <span class="number">123</span> &#125;); <span class="comment">// 调用 https://api.example.com/users</span></span><br><span class="line"><span class="keyword">const</span> orderData = <span class="keyword">await</span> api.<span class="title function_">orders</span>(&#123; <span class="attr">userId</span>: <span class="number">123</span> &#125;); <span class="comment">// 调用 https://api.example.com/orders</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-自动持久化：修改数据自动存到本地存储"><a href="#3-4-自动持久化：修改数据自动存到本地存储" class="headerlink" title="3.4 自动持久化：修改数据自动存到本地存储"></a>3.4 自动持久化：修改数据自动存到本地存储</h3><p>比如让配置数据修改后自动保存到 <code>localStorage</code>，刷新页面也不会丢：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建“自动持久化”的代理函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createPersistentState</span>(<span class="params">storageKey, initialState</span>) &#123;</span><br><span class="line">  <span class="comment">// 从 localStorage 读取已有数据（没有则用初始值）</span></span><br><span class="line">  <span class="keyword">const</span> storedData = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(storageKey);</span><br><span class="line">  <span class="keyword">const</span> state = storedData ? <span class="title class_">JSON</span>.<span class="title function_">parse</span>(storedData) : initialState;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 拦截 set 操作：修改后自动保存</span></span><br><span class="line">  <span class="keyword">const</span> handler = &#123;</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, propKey, value</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> success = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, propKey, value);</span><br><span class="line">      <span class="comment">// 自动同步到 localStorage</span></span><br><span class="line">      <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(storageKey, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(target));</span><br><span class="line">      <span class="keyword">return</span> success;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(state, handler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建自动持久化的配置对象</span></span><br><span class="line"><span class="keyword">const</span> appSettings = <span class="title function_">createPersistentState</span>(<span class="string">&#x27;app-settings&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">theme</span>: <span class="string">&#x27;light&#x27;</span>,</span><br><span class="line">  <span class="attr">fontSize</span>: <span class="number">16</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试：修改后自动保存到 localStorage</span></span><br><span class="line">appSettings.<span class="property">theme</span> = <span class="string">&#x27;dark&#x27;</span>; <span class="comment">// localStorage 里的 app-settings 会自动更新</span></span><br><span class="line">appSettings.<span class="property">fontSize</span> = <span class="number">18</span>; <span class="comment">// 同样自动保存</span></span><br></pre></td></tr></table></figure>

<h3 id="3-5-数组变化监听：完美支持数组方法"><a href="#3-5-数组变化监听：完美支持数组方法" class="headerlink" title="3.5 数组变化监听：完美支持数组方法"></a>3.5 数组变化监听：完美支持数组方法</h3><p>Proxy 能原生拦截数组的 <code>push</code>、<code>pop</code>、<code>splice</code> 等方法，不用像 <code>Object.defineProperty</code> 那样做特殊 hack：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数组拦截器：监控数组操作</span></span><br><span class="line"><span class="keyword">const</span> arrayHandler = &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">target, propKey</span>) &#123;</span><br><span class="line">    <span class="comment">// 拦截数组的变异方法（push、pop 等）</span></span><br><span class="line">    <span class="keyword">const</span> mutationMethods = [<span class="string">&#x27;push&#x27;</span>, <span class="string">&#x27;pop&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;unshift&#x27;</span>, <span class="string">&#x27;splice&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (mutationMethods.<span class="title function_">includes</span>(propKey)) &#123;</span><br><span class="line">      <span class="comment">// 返回包装后的方法，保留原逻辑并加监控</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`数组执行 <span class="subst">$&#123;propKey&#125;</span>，参数：`</span>, args);</span><br><span class="line">        <span class="comment">// 调用数组原生方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>[propKey].<span class="title function_">apply</span>(target, args);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 非数组方法，走默认逻辑</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, propKey);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试数组代理</span></span><br><span class="line"><span class="keyword">const</span> list = <span class="keyword">new</span> <span class="title class_">Proxy</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], arrayHandler);</span><br><span class="line">list.<span class="title function_">push</span>(<span class="number">4</span>); <span class="comment">// 触发拦截：输出“数组执行 push，参数：[4]”，数组变成 [1,2,3,4]</span></span><br><span class="line">list.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="number">1</span>); <span class="comment">// 触发拦截：输出“数组执行 splice，参数：[0,1]”，数组变成 [2,3,4]</span></span><br></pre></td></tr></table></figure>

<h2 id="四、Proxy-实战注意事项与优化"><a href="#四、Proxy-实战注意事项与优化" class="headerlink" title="四、Proxy 实战注意事项与优化"></a>四、Proxy 实战注意事项与优化</h2><h3 id="4-1-必须用-Reflect-保持默认行为"><a href="#4-1-必须用-Reflect-保持默认行为" class="headerlink" title="4.1 必须用 Reflect 保持默认行为"></a>4.1 必须用 Reflect 保持默认行为</h3><p><code>Reflect</code> 是 ES6 配合 Proxy 推出的 API，它的方法和 Proxy 的拦截器一一对应（比如 <code>Reflect.get</code> 对应 <code>get</code> 拦截器）。在拦截器里用 <code>Reflect</code> 而不是直接操作 <code>target</code>，能确保：</p>
<ul>
<li>保持对象的默认行为（比如 <code>this</code> 指向正确）；</li>
<li>正确处理复杂场景（比如继承属性、不可写属性）。</li>
</ul>
<p>反例（不推荐）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> badHandler = &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">target, propKey</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> target[propKey]; <span class="comment">// 直接操作 target，可能破坏继承等默认行为</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>正例（推荐）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> goodHandler = &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">target, propKey, receiver</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, propKey, receiver); <span class="comment">// 用 Reflect 保持默认行为</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-避免过度代理：减少性能开销"><a href="#4-2-避免过度代理：减少性能开销" class="headerlink" title="4.2 避免过度代理：减少性能开销"></a>4.2 避免过度代理：减少性能开销</h3><p>Proxy 虽然灵活，但创建和递归代理会有性能开销，尤其是处理大型对象或频繁操作时。优化技巧：</p>
<ol>
<li><strong>避免重复代理</strong>：用 <code>WeakMap</code> 缓存已代理的对象，同一对象只代理一次（参考 3.1 响应式的 <code>reactiveMap</code>）；</li>
<li><strong>浅层代理优先</strong>：如果只需要监控顶层属性，不用递归代理嵌套对象；</li>
<li><strong>性能关键场景不用 Proxy</strong>：比如高频更新的列表、大型数据计算，用普通对象更高效。</li>
</ol>
<h3 id="4-3-嵌套对象代理：需要递归处理"><a href="#4-3-嵌套对象代理：需要递归处理" class="headerlink" title="4.3 嵌套对象代理：需要递归处理"></a>4.3 嵌套对象代理：需要递归处理</h3><p>Proxy 只能拦截“直接操作的属性”，如果目标对象有嵌套对象（比如 <code>user.address.city</code>），直接代理顶层对象无法拦截嵌套属性的操作——需要在 <code>get</code> 拦截器里递归代理嵌套对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nestedHandler = &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">target, propKey, receiver</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> value = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, propKey, receiver);</span><br><span class="line">    <span class="comment">// 如果值是对象且非 null，递归代理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&#x27;object&#x27;</span> &amp;&amp; value !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(value, nestedHandler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">set</span>(<span class="params">target, propKey, value</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`修改 <span class="subst">$&#123;propKey&#125;</span>：<span class="subst">$&#123;value&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, propKey, value);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试嵌套代理</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123; <span class="attr">address</span>: &#123; <span class="attr">city</span>: <span class="string">&#x27;Beijing&#x27;</span> &#125; &#125;, nestedHandler);</span><br><span class="line">user.<span class="property">address</span>.<span class="property">city</span> = <span class="string">&#x27;Shanghai&#x27;</span>; <span class="comment">// 触发 set：输出“修改 city：Shanghai”</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-浏览器兼容性：旧环境回退"><a href="#4-4-浏览器兼容性：旧环境回退" class="headerlink" title="4.4 浏览器兼容性：旧环境回退"></a>4.4 浏览器兼容性：旧环境回退</h3><p>Proxy 不支持 IE 浏览器，如果需要兼容旧环境，可以用 <code>Object.defineProperty</code> 做回退（类似 Vue2 的响应式方案）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createCompatProxy</span>(<span class="params">target, handler</span>) &#123;</span><br><span class="line">  <span class="comment">// 现代浏览器：用 Proxy</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">Proxy</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(target, handler);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 旧浏览器：用 Object.defineProperty 模拟（仅支持 get/set）</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(target)) &#123;</span><br><span class="line">    <span class="comment">// 数组回退：拦截索引和长度</span></span><br><span class="line">    target.<span class="title function_">forEach</span>(<span class="function">(<span class="params">_, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(target, index, &#123;</span><br><span class="line">        <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> handler.<span class="property">get</span>?.(target, index);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">set</span>(<span class="params">value</span>) &#123;</span><br><span class="line">          handler.<span class="property">set</span>?.(target, index, value);</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 对象回退：拦截属性</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">keys</span>(target).<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(target, key, &#123;</span><br><span class="line">        <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> handler.<span class="property">get</span>?.(target, key);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">set</span>(<span class="params">value</span>) &#123;</span><br><span class="line">          handler.<span class="property">set</span>?.(target, key, value);</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="五、Proxy-vs-Object-defineProperty：核心差异"><a href="#五、Proxy-vs-Object-defineProperty：核心差异" class="headerlink" title="五、Proxy vs Object.defineProperty：核心差异"></a>五、Proxy vs Object.defineProperty：核心差异</h2><p>很多人会把 Proxy 和 ES5 的 <code>Object.defineProperty</code> 对比，两者都是“对象拦截”方案，但 Proxy 更强大、更灵活：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>Proxy（ES6）</th>
<th>Object.defineProperty（ES5）</th>
</tr>
</thead>
<tbody><tr>
<td>嵌套对象监听</td>
<td>✅ 支持（需递归代理）</td>
<td>❌ 不支持，需手动递归实现</td>
</tr>
<tr>
<td>数组监听</td>
<td>✅ 原生支持（push、splice 等方法）</td>
<td>❌ 需 hack 数组原型，不完美</td>
</tr>
<tr>
<td>新增属性监听</td>
<td>✅ 自动支持（比如 <code>proxy.newKey = 1</code>）</td>
<td>❌ 不支持，需手动调用 <code>defineProperty</code></td>
</tr>
<tr>
<td>删除属性监听</td>
<td>✅ 支持（<code>delete proxy.key</code>）</td>
<td>❌ 不支持</td>
</tr>
<tr>
<td>拦截操作数量</td>
<td>13 种（覆盖所有对象操作）</td>
<td>仅 2 种（get&#x2F;set）</td>
</tr>
<tr>
<td>性能</td>
<td>现代浏览器优化良好，一般场景足够用</td>
<td>稍快，但功能有限</td>
</tr>
<tr>
<td>浏览器支持</td>
<td>现代浏览器（Chrome、Firefox、Edge），不支持 IE</td>
<td>支持到 IE9</td>
</tr>
</tbody></table>
<p>简单说：如果不需要兼容 IE，优先用 Proxy；如果需要兼容旧环境，才考虑 <code>Object.defineProperty</code>。</p>
<h2 id="六、Proxy-的局限性"><a href="#六、Proxy-的局限性" class="headerlink" title="六、Proxy 的局限性"></a>六、Proxy 的局限性</h2><p>Proxy 虽强，但也有一些无法突破的限制：</p>
<ol>
<li><strong>无法拦截全等比较</strong>：<code>proxy === target</code> 永远是 <code>false</code>（代理和原对象是两个不同的引用）；</li>
<li><strong>无法拦截某些内部方法</strong>：比如 <code>Object.prototype.toString.call(proxy)</code>，返回的是代理对象的类型，无法自定义；</li>
<li><strong>序列化问题</strong>：代理对象不能直接用 <code>JSON.stringify</code> 序列化（会序列化原对象的属性，但拦截逻辑不生效）；</li>
<li><strong>内存消耗</strong>：深度代理大型对象（比如嵌套多层的数组&#x2F;对象），会占用较多内存。</li>
</ol>
<hr>
<p>Proxy 是 ES6 中最强大的特性之一，它的核心价值在于“不修改原对象，却能自定义对象的行为”——这种“非侵入式”的拦截能力，让它在框架开发、工具库、数据处理等场景中大放异彩。掌握 Proxy，不仅能看懂 Vue3 等框架的底层逻辑，还能写出更灵活、更优雅的代码～</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/site/avatar.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/site/avatar.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">Touko</div><div class="post-copyright__author_desc">🐾猫爪按日出, 按出彩虹糖🌈</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://toukoxu.github.io/2024/08/15/proxy/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://toukoxu.github.io/2024/08/15/proxy/')">代理（Proxy）：ES6 元编程的“对象拦截器”</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/pay/wechat.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/pay/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/pay/alipay.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/pay/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://toukoxu.github.io/2024/08/15/proxy/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://toukoxu.github.io" target="_blank">Touko</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/%E5%89%8D%E7%AB%AF/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>前端<span class="categoryesPageCount">10</span></a><a class="post-meta__box__categoryes" href="/categories/%E5%89%8D%E7%AB%AF/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>学习笔记<span class="categoryesPageCount">10</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/JavaScript/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>JavaScript<span class="tagsPageCount">10</span></a><a class="post-meta__box__tags" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>性能优化<span class="tagsPageCount">6</span></a><a class="post-meta__box__tags" href="/tags/ES6/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>ES6<span class="tagsPageCount">6</span></a></div></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2024/08/14/reflect/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/reflect.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Reflect：ES6 标准化对象操作的“工具库”</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2021/05/02/prototype-chain/" title="原型链（Prototype Chain）与 Class：吃透 JS 对象继承的核心"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/prototype-chain.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2021-05-02</div><div class="title">原型链（Prototype Chain）与 Class：吃透 JS 对象继承的核心</div></div></a></div><div><a href="/2024/07/13/async&await/" title="Async&#x2F;Await：用同步的方式写异步，真香！"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/async.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-13</div><div class="title">Async&#x2F;Await：用同步的方式写异步，真香！</div></div></a></div><div><a href="/2024/07/11/generator/" title="生成器函数与 yield：掌控函数执行的“暂停键”"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/generator.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-11</div><div class="title">生成器函数与 yield：掌控函数执行的“暂停键”</div></div></a></div><div><a href="/2021/04/03/closure/" title="闭包（Closure）：JavaScript 里的“记忆小助手”"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/closure.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2021-04-03</div><div class="title">闭包（Closure）：JavaScript 里的“记忆小助手”</div></div></a></div><div><a href="/2022/02/01/event/" title="JS 事件系统完全指南与性能优化"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/event.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2022-02-01</div><div class="title">JS 事件系统完全指南与性能优化</div></div></a></div><div><a href="/2024/06/23/message-channel/" title="MessageChannel 详解：浏览器中的“点对点双向通信管道”"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/message-channel.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-23</div><div class="title">MessageChannel 详解：浏览器中的“点对点双向通信管道”</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/site/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/emoji/sparkles.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">欢迎来到我的<b style="color:#fff">编程小天地</b>！这里有可爱的<b style="color:#fff">编程知识点</b>，致力于把复杂的概念变得<b style="color:#fff">简单可爱</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">一起探索，让代码生活更精彩！</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Touko</h1><div class="author-info__desc">🐾猫爪按日出, 按出彩虹糖🌈</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/ToukoXu" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">😊 欢迎来看我的博客鸭~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">关联知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81Proxy-%E7%9A%84%E6%A0%B8%E5%BF%83%EF%BC%9A%E4%B8%89%E8%A6%81%E7%B4%A0%E4%B8%8E%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">一、Proxy 的核心：三要素与基础用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%8113-%E7%A7%8D%E6%A0%B8%E5%BF%83%E6%8B%A6%E6%88%AA%E6%96%B9%E6%B3%95%EF%BC%9A%E8%A6%86%E7%9B%96%E6%89%80%E6%9C%89%E5%AF%B9%E8%B1%A1%E6%93%8D%E4%BD%9C"><span class="toc-number">3.</span> <span class="toc-text">二、13 种核心拦截方法：覆盖所有对象操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Proxy-%E7%9A%84%E5%AE%9E%E6%88%98%E5%9C%BA%E6%99%AF%EF%BC%9A%E8%BF%99%E4%BA%9B%E5%9C%B0%E6%96%B9%E7%94%A8%E5%AE%83%E6%9C%80%E9%A6%99"><span class="toc-number">4.</span> <span class="toc-text">三、Proxy 的实战场景：这些地方用它最香</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%EF%BC%88Vue3-%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%EF%BC%89"><span class="toc-number">4.1.</span> <span class="toc-text">3.1 响应式数据（Vue3 核心原理）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81%EF%BC%9A%E7%A1%AE%E4%BF%9D%E5%B1%9E%E6%80%A7%E5%80%BC%E7%AC%A6%E5%90%88%E8%A7%84%E5%88%99"><span class="toc-number">4.2.</span> <span class="toc-text">3.2 数据验证：确保属性值符合规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-API-%E8%AF%B7%E6%B1%82%E6%8B%A6%E6%88%AA%EF%BC%9A%E7%BB%9F%E4%B8%80%E7%AE%A1%E7%90%86%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8"><span class="toc-number">4.3.</span> <span class="toc-text">3.3 API 请求拦截：统一管理接口调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E8%87%AA%E5%8A%A8%E6%8C%81%E4%B9%85%E5%8C%96%EF%BC%9A%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE%E8%87%AA%E5%8A%A8%E5%AD%98%E5%88%B0%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8"><span class="toc-number">4.4.</span> <span class="toc-text">3.4 自动持久化：修改数据自动存到本地存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E6%95%B0%E7%BB%84%E5%8F%98%E5%8C%96%E7%9B%91%E5%90%AC%EF%BC%9A%E5%AE%8C%E7%BE%8E%E6%94%AF%E6%8C%81%E6%95%B0%E7%BB%84%E6%96%B9%E6%B3%95"><span class="toc-number">4.5.</span> <span class="toc-text">3.5 数组变化监听：完美支持数组方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Proxy-%E5%AE%9E%E6%88%98%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="toc-number">5.</span> <span class="toc-text">四、Proxy 实战注意事项与优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%BF%85%E9%A1%BB%E7%94%A8-Reflect-%E4%BF%9D%E6%8C%81%E9%BB%98%E8%AE%A4%E8%A1%8C%E4%B8%BA"><span class="toc-number">5.1.</span> <span class="toc-text">4.1 必须用 Reflect 保持默认行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E9%81%BF%E5%85%8D%E8%BF%87%E5%BA%A6%E4%BB%A3%E7%90%86%EF%BC%9A%E5%87%8F%E5%B0%91%E6%80%A7%E8%83%BD%E5%BC%80%E9%94%80"><span class="toc-number">5.2.</span> <span class="toc-text">4.2 避免过度代理：减少性能开销</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%B5%8C%E5%A5%97%E5%AF%B9%E8%B1%A1%E4%BB%A3%E7%90%86%EF%BC%9A%E9%9C%80%E8%A6%81%E9%80%92%E5%BD%92%E5%A4%84%E7%90%86"><span class="toc-number">5.3.</span> <span class="toc-text">4.3 嵌套对象代理：需要递归处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E6%B5%8F%E8%A7%88%E5%99%A8%E5%85%BC%E5%AE%B9%E6%80%A7%EF%BC%9A%E6%97%A7%E7%8E%AF%E5%A2%83%E5%9B%9E%E9%80%80"><span class="toc-number">5.4.</span> <span class="toc-text">4.4 浏览器兼容性：旧环境回退</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81Proxy-vs-Object-defineProperty%EF%BC%9A%E6%A0%B8%E5%BF%83%E5%B7%AE%E5%BC%82"><span class="toc-number">6.</span> <span class="toc-text">五、Proxy vs Object.defineProperty：核心差异</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81Proxy-%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">7.</span> <span class="toc-text">六、Proxy 的局限性</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/08/15/proxy/" title="代理（Proxy）：ES6 元编程的“对象拦截器”"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/proxy.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="代理（Proxy）：ES6 元编程的“对象拦截器”"/></a><div class="content"><a class="title" href="/2024/08/15/proxy/" title="代理（Proxy）：ES6 元编程的“对象拦截器”">代理（Proxy）：ES6 元编程的“对象拦截器”</a><time datetime="2024-08-15T12:46:25.000Z" title="发表于 2024-08-15 20:46:25">2024-08-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/14/reflect/" title="Reflect：ES6 标准化对象操作的“工具库”"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/reflect.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Reflect：ES6 标准化对象操作的“工具库”"/></a><div class="content"><a class="title" href="/2024/08/14/reflect/" title="Reflect：ES6 标准化对象操作的“工具库”">Reflect：ES6 标准化对象操作的“工具库”</a><time datetime="2024-08-14T12:46:25.000Z" title="发表于 2024-08-14 20:46:25">2024-08-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/13/async&amp;await/" title="Async/Await：用同步的方式写异步，真香！"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/async.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Async/Await：用同步的方式写异步，真香！"/></a><div class="content"><a class="title" href="/2024/07/13/async&amp;await/" title="Async/Await：用同步的方式写异步，真香！">Async/Await：用同步的方式写异步，真香！</a><time datetime="2024-07-13T12:46:25.000Z" title="发表于 2024-07-13 20:46:25">2024-07-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/11/generator/" title="生成器函数与 yield：掌控函数执行的“暂停键”"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/generator.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="生成器函数与 yield：掌控函数执行的“暂停键”"/></a><div class="content"><a class="title" href="/2024/07/11/generator/" title="生成器函数与 yield：掌控函数执行的“暂停键”">生成器函数与 yield：掌控函数执行的“暂停键”</a><time datetime="2024-07-11T12:46:25.000Z" title="发表于 2024-07-11 20:46:25">2024-07-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/23/message-channel/" title="MessageChannel 详解：浏览器中的“点对点双向通信管道”"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/toukoxu/picstore@1.0.0/images/cover/message-channel.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MessageChannel 详解：浏览器中的“点对点双向通信管道”"/></a><div class="content"><a class="title" href="/2024/06/23/message-channel/" title="MessageChannel 详解：浏览器中的“点对点双向通信管道”">MessageChannel 详解：浏览器中的“点对点双向通信管道”</a><time datetime="2024-06-23T12:46:25.000Z" title="发表于 2024-06-23 20:46:25">2024-06-23</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2025 By <a class="footer-bar-link" href="/" title="Touko" target="_blank">Touko</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = ["生活明朗&#44; 万物可爱&#44; 人间值得&#44; 未来可期."]
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div></div><div class="footer-bar-right"></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">2</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/ES2017-ES8/" style="font-size: 0.88rem;">ES2017(ES8)<sup>1</sup></a><a href="/tags/ES6/" style="font-size: 0.88rem;">ES6<sup>6</sup></a><a href="/tags/JavaScript/" style="font-size: 0.88rem; font-weight: 500; color: var(--anzhiyu-lighttext)">JavaScript<sup>10</sup></a><a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 0.88rem;">性能优化<sup>6</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"><a class="tag-list" href="/tags/JavaScript" title="JavaScript">JavaScript</a><a class="tag-list" href="/tags/Vue" title="Vue">Vue</a></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.2/dist/svg-pan-zoom.min.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [`叮！可爱加载中... `, `🐱`];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `%c ${ascll[0]} %c${ascll[1]}`,
      "color:white; background-color:#f0ad4e",
      ''
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "你正在访问 Touko 的博客.",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
          const svgElement = document.getElementById(mermaidID)
          const viewBox = svgElement.getAttribute('viewBox')
          const viewBoxValues = viewBox.split(/[\s,]+/)
          window.svgPanZoom ? svgPanZoom(svgElement, { contain: true, controlIconsEnabled: true }) : ''
          const width = Number(getComputedStyle(svgElement).getPropertyValue('width').slice(0, -2))
          svgElement.setAttribute('height', `${viewBoxValues[3] * width / viewBoxValues[2]}px`)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js').then(runMermaid)
  }

  anzhiyu.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'BsIRp7GQE8IZ5fkI0JRj8Vys-gzGzoHsz',
      appKey: 'vla82YKrFnfwtuQfgoaDnzu9',
      avatar: 'mp',
      serverURLs: 'https://bsirp7gq.lc-cn-n1-shared.com',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://bsirp7gq.lc-cn-n1-shared.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": 'BsIRp7GQE8IZ5fkI0JRj8Vys-gzGzoHsz',
        "X-LC-Key": 'vla82YKrFnfwtuQfgoaDnzu9',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "visitor@touko.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>